────────────────────────────────
HIGHLOWトレンド判定思想（最終確定版・ダウ理論状態機械型）
────────────────────────────────

■ 1. 基本思想

・判定はダウ理論ベース（構造連鎖型） ・終値（確定足Close）でのみ判定
・ヒゲでは判定しない ・状態保持あり（UP / DOWN / TRENDLESS の状態機械）
・pivotは非リペイント（右側3本確定で固定）
・表示に使う確定pivotのみを判定に使用（表示＝真実）
・H1/M5はロジック完全共通（時間足が違うだけ）

────────────────────────────────

■ 2. レベル定義

・直近LLの直前にあるLH ＝ Down終了判定レベル（KeyLH）
・直近HHの直前にあるHL ＝ Up終了判定レベル（KeyHL）
・直近HLの後に形成された直近高値（HHまたはLH） ＝
Up確定トリガー（TriggerHigh）
・直近LHの後に形成された直近安値（HLまたはLL） ＝
Down確定トリガー（TriggerLow）

取得方法：
確定pivot配列を末尾から逆走査し、表示Kind（HH/HL/LH/LL）をそのまま使用。
再ラベリングは禁止。

────────────────────────────────

■ 3. トレンド状態の定義（状態機械）

状態は3つのみ：

UP DOWN TRENDLESS

【Down中】 KeyLHを終値で上抜け → TRENDLESS（Down終了）

【TRENDLESS（Down終了後）】 HL形成後、TriggerHighを終値で上抜け → UP確定

【Up中】 KeyHLを終値で下抜け → TRENDLESS（Up終了）

【TRENDLESS（Up終了後）】 LH形成後、TriggerLowを終値で下抜け → DOWN確定
*既に終値で下回っている場合も含む

────────────────────────────────

■ 4. 強制反転ルール（急変時）

Up中に

・KeyHL終値割れ かつ ・TriggerLow終値割れ

を同一バーで満たした場合、

TrendLessを経由せず即DOWN確定。

Down中も対称：

・KeyLH終値上抜け かつ ・TriggerHigh終値上抜け

で即UP確定。

────────────────────────────────

■ 5. 判定優先順位

(1) 強制反転判定
(2) 終了判定（KeyHL / KeyLH）
(3) 確定判定（TriggerHigh / TriggerLow）
(4) その他 → 現在状態を維持

※ 判定は厳密不等号（> / <） ※ 同値はブレイクとみなさない

────────────────────────────────

■ 6. 判定タイミング

・確定足更新時のみ判定 ・pivot確定後に判定実行
・起動時は過去pivotから状態を再構築

────────────────────────────────

■ 7. TrendLessの意味

TrendLessは

・トレンド終了直後 ・転換待機中 ・構造未完成段階

を示す中立状態である。

レンジとは限らない。

────────────────────────────────

■ 8. 本思想の核心

トレンドは

「高値更新したから始まる」のではない。

HL → 高値更新 LH → 安値更新

という構造完成をもって初めて確定する。

確定後は、構造が破壊されるまでその方向を維持する。

これが最終思想。
