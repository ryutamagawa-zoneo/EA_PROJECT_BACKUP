引き継ぎ仕様書（FundedHIVE Compliance：確定版）
2.1 目的

FundedHIVE（PAP / NewBee）での失格回避を最優先。

ルール達成（損失停止／合格停止）を確実化し、停止中の注文エラー連打・取り残しをゼロ化する。

2.2 停止モード（単一状態変数：確定）

停止モード = 0: 通常 / 1: 日次停止 / 2: 永久停止

保持フィールド（確定：B3-B）

停止理由（string）

停止期限（DateTime?）

日次停止 解除時刻（確定）

JST 09:30 固定で解除（翌日）。

休場日でも 09:30 で解除状態に戻す（市場が閉じていれば自然に取引は発生しない）。

永久停止 解除（確定）

手動のみ。自動解除なし。

2.3 A：取引許可ゲート（BASE公開API：仕様）

BASEは以下を提供し、Complianceはこれのみで取引可否を制御する。

取引許可（bool）：新規注文／保留注文発行の直前でBASEが必ず参照

false の間は 発注処理を開始せず return

取引停止理由（string）：停止理由保持

取引停止期限（DateTime?）：日次停止解除用（永久停止は null 可）

状態変更時は識別ログを必ず出力（CODE NAME / BotLabel 等）

2.4 日次損失による日次停止（確定）

判定基準：当日開始 Equity

閾値：-1.8%

発動時の順序（確定）

全決済（C）

停止モード = 1（日次停止）

停止期限 = 翌日 JST 09:30

停止中は取引関連処理を行わない（監視・ログのみ）

2.5 合格（利益達成）による永久停止（確定）

初期残高：ユーザーがパラメータ入力（自動取得なし）

判定：Equity

目標利益率：パラメータ

一次：+8%

二次：+6%

同時有効は禁止（どちらか一方のみ）

確定方式（P3：確定）

一度でも到達した瞬間に合格確定（保持時間・バッファなし）

発動時の順序

全決済（C）

停止モード = 2（永久停止）

自動解除なし（手動のみ）

優先順位

永久停止（合格） ＞ 日次停止（損失）

同一タイミングで両条件成立なら永久停止を優先。

2.6 判定タイミング（確定）

OnTick + OnTimer（2秒）

連打防止：G1（状態遷移ガード）

すでに停止モードが同じなら、停止処理（全決済含む）を再実行しない。

ログには判定ソース（OnTick / OnTimer）を記録する。

2.7 C：全決済（確定）
対象（C1-B：確定）

ポジション + 保留注文

順序（C2-A：確定）

保留注文を全キャンセル

ポジションを全クローズ

失敗時（C3-B：確定）

失敗した対象のみを再試行

回数限定リトライ（N回）（推奨：N=3）

リトライ間隔：1〜2秒

N回失敗後は 打ち切り

停止モードは維持

失敗をログに残す

2.8 ログ仕様（L2：確定）

ログは イベント時のみ出力（常時ログは出さない）。

出力イベント

日次停止 発動

永久停止（合格） 発動

日次停止 解除（JST 09:30）

全決済 実行結果（成功／一部失敗／打ち切り）

各イベントで必須のスナップショット項目

CODE NAME（フル）

BotLabel

Symbol

口座ID

イベント種別

停止モード（0/1/2）

停止理由

停止期限

Balance / Equity

初期残高（入力値）

当日開始 Equity

損失率（%）または利益率（%）

判定ソース（OnTick / OnTimer）

発生時刻（JST）